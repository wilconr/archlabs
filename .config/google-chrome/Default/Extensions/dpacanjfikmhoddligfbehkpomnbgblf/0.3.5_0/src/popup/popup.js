!function(){function e(){Handlebars.registerHelper("if_even",function(e,t){return(e+1)%2==0?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("format_date",function(e,t){var r=new Date;return r.setTime(parseInt(e)),r.format("yyyy/MM/dd hh:mm:ss")});var e=$("#music_info_template").html(),t=Handlebars.compile(e),r=function(e,t){var r="success";-1==t&&(r="error"),$("#search_result").hide(),$("#search_result").html("<div class='"+r+"'>"+e+"</div>"),$("#search_result").slideDown("slow")},n=function(e){var r=t({music_infos:[e]}),s=$(r).addClass("success");$("#search_result").append(s),$("#search_result").slideDown("slow")},a=function(e){if(void 0!==e){$("#history_music_info").html("");var r=t({music_infos:e});$("#history_music_info").html(r),$("#history_music_info").slideDown("slow")}$("a").each(function(){var e=$(this).attr("url"),t=$(this).attr("is_set_click");e&&!t&&($(this).attr("is_set_click","true"),$(this).click(function(){var t=$(this).attr("name");s.push(["_trackEvent",t,"clicked"]),chrome.tabs.create({url:e})}))})};return{start:function(){$("#search_bar_start").hide(),$("#search_bar_running").show()},stop:function(){$("#search_bar_start").show(),$("#search_bar_running").hide()},show_message:r,refresh:a,reset:function(){$("#search_result").fadeOut(),$("#search_result").html("")},show_new_result:n,clear_history:function(){$("#search_result").html("")}}}function t(e){var t=e;chrome.runtime.onMessage.addListener(function(e,r,s){switch(e.cmd){case"popup_init":case"popup_reload":console.log(e.result),t.refresh(e.result.data),e.result.recognize_status&&t.start();break;case"popup_parse_result":t.show_new_result(e.result.data);break;case"popup_error":case"popup_update_version":console.log(e.result),t.show_message(e.result.msg,-1);break;case"popup_login":t.show_message('Please <a url="chrome://chrome-signin/" href="#"> login with your google account</a>',-1);break;case"popup_export":e.result.data.forEach(function(e,t,r){e.detail_url="https://www.aha-music.com/"+e.acr_id+"?utm_source=chrome&utm_medium=extension"});var n=[{column:"acr_id",title:"ACR_ID"},{column:"title",title:"Title"},{column:"artist",title:"Artists"},{column:"timestamp",title:"Time",formatter:function(e){var t=new Date;return t.setTime(parseInt(e)),t.format("yyyy/MM/dd hh:mm:ss")}},{column:"tab_url",title:"Source_URL"},{column:"detail_url",title:"Detail_URL"}];_g_utils.save_csv(n,e.result.data,"aha_music_export.csv")}"popup_init"!=e.cmd&&t.stop(),t.refresh()});var r=function(){this.cancel(),chrome.runtime.sendMessage({cmd:"background_start"}),t.start()},s=function(){t.reset(),chrome.runtime.sendMessage({cmd:"background_cancel"})},n=function(){chrome.runtime.sendMessage({cmd:"background_reload"})};return{init:function(){chrome.runtime.sendMessage({cmd:"background_init"})},reload:n,start:r,cancel:s,clear_history:function(){confirm("Do you want to clear history?")&&(chrome.runtime.sendMessage({cmd:"background_clear_history"}),t.clear_history())},export_history:function(){confirm("Do you want to export history?")&&chrome.runtime.sendMessage({cmd:"background_export_history"})}}}function r(){Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e};var r=e(),n=t(r);$("#search_bar_start").click(function(){s.push(["_trackEvent","search_bar_start","clicked"]),n.start()}),$("#clear_history").click(function(){s.push(["_trackEvent","recycle","clicked"]),n.clear_history()}),$("#export_history").click(function(){s.push(["_trackEvent","export_history","clicked"]),n.export_history()}),n.init(),n.start(),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://ssl.google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}var s=s||[];s.push(["_setAccount","UA-101242276-1"]),s.push(["_trackPageview"]),_g_utils=function(){function e(e,t){var r=e.reduce(function(e,t){return(e?e+",":"")+(t.title||t.column)},"");if(Array.isArray(t)&&t.length>0){var s=e.map(function(e){return e.column});r=t.reduce(function(t,r){return t+"\r\n"+s.reduce(function(t,s){if(r.hasOwnProperty(s)){var n=r[s];if(null!=n){var a=e.find(function(e){return e.column==s});if(null!=a.formatter&&"function"==typeof a.formatter&&(n=a.formatter(n)),null!=n)return n=n.toString().replace(new RegExp("\r\n","g")," "),n=new RegExp(",").test(n)?'"'+n+'"':n,t?t+","+n:t+n}return t?t+",":t+" "}return t?t+",":t+" "},"")},r)}return new Blob(["\ufeff"+r],{type:"text/csv;charset=utf-8;"})}function t(t,r,s){if(Array.isArray(t)&&t.length>0){s&&"string"==typeof s||(fileName="export.csv");var n=e(t,r);if(navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(n,s);else{var a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=s,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}}}return{save_csv:t}}(),$(window).load(function(){var e=new Date,t=e.getFullYear();$("#copyright_year").html(t),setTimeout(r,800)})}();
