"use strict";var vid,APP_DATA={showSlackPopup:!0,server:"prod",updatedDevice:!1},ENV=chrome.runtime.getManifest().sidebar_action?"WHALE":"CHROME",hostname="https://"+("test"===getAppData("server")?"test":"web-staging"===getAppData("server")?"staging":"chromeext")+".send-anywhere.com",website_url=hostname.replace("chromeext.","")+"/",uploadList={},xhrList={},lang=(window.navigator.userLanguage||window.navigator.language).split("-")[0];lang="ko"==lang||"ja"==lang?lang:"en";var USER_AUTH_ERORR_TYPE=["invalid_user_id","invalid_user_token","invalid_user_type","invalid_provider"];const PERMISSIONS_PDF=["*://*/*.pdf","file:///*.pdf"],log=(...e)=>{"test"===getAppData("server")&&console.log(...e)};function getAppData(e){return e?APP_DATA[e]:APP_DATA}function setAppData(e,t){if(e){var n=getAppData(e);if("object"!=typeof t&&t===n)return;log("setData:",e,", old:",n,", new:",t),APP_DATA[e]=t,"userId"===e&&(t?chrome.storage.sync.set({user_id:t}):chrome.storage.sync.remove("user_id"),"CHROME"===ENV&&addBrowserAction())}}function refreshSocialToken(e){chrome.tabs.executeScript(e,{code:'var saHostname = "'+hostname+'";'},(function(){chrome.tabs.executeScript(e,{file:"/js/refresh-social-token.js"})}))}function addContextMenu(e){"image"==e?chrome.contextMenus.create({id:"sa_img_context",title:chrome.i18n.getMessage("upload_image"),contexts:["image"],onclick:function(e,t){ga("send","event","context","click","image_share_bt"),!!getAppData("userId")?(refreshSocialToken(t.id),injectIframe(e.srcUrl,t.id)):alert(chrome.i18n.getMessage("login_required"))}}):"editable"==e&&chrome.contextMenus.create({id:"sa_editable_context",title:chrome.i18n.getMessage("gmail_hover_title"),contexts:["editable"],documentUrlPatterns:["*://*.slack.com/*"],onclick:function(e,t){ga("send","event","context","click","input_context_bt"),chrome.tabs.sendMessage(t.id,{type:"load_embedded_webapp",item:"editable"},(function(){}))}})}function removeContextMenu(e){"image"===e?chrome.contextMenus.remove("sa_img_context"):"editable"===e&&chrome.contextMenus.remove("sa_editable_context")}function openWebapp(){"CHROME"!==ENV&&openSidebar()}function openSidebar(){checkAuth((function(){whale.sidebarAction.show()}))}function broadcastToContentScript(e){chrome.tabs.query({url:["https://*.slack.com/*","https://mail.google.com/*","https://inbox.google.com/*"]},(function(t){for(var n=0;n<t.length;n++){var o=t[n];chrome.tabs.sendMessage(o.id,e,(function(e){log(e)}))}}))}function updatedSessionCookie(e){chrome.cookies.get({url:hostname,name:e},(function(t){if(t){if("session_key"==e){var n=decodeJWT(t.value);n&&(!getAppData("userId")&&n.id&&(broadcastToContentScript({action:"refresh_webapp",type:"login"}),closeLoginPopup()),setAppData("userId",n.id))}}else"session_key"==e&&(getAppData("userId")&&broadcastToContentScript({action:"refresh_webapp",type:"logout"}),setAppData("userId",void 0))}))}function requestPdfPermissions(e){const t=getAppData("options");t&&t.pdf&&chrome.permissions.contains({origins:PERMISSIONS_PDF},(function(t){t?e&&e(!0):chrome.permissions.request({origins:PERMISSIONS_PDF},(function(t){e&&e(t)}))}))}function injectIframe(e,t){checkAuth((function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(n){var o=t||n[0].id;chrome.tabs.executeScript(o,{file:"/js/inject-iframe.js"},(function(){chrome.tabs.insertCSS(o,{file:"/css/injection.css"},(function(){downloadData(e,o)}))}))}))}))}function encodePath(e){return e.match(/%[0-9a-f]{2}/i)?encodeURI(encodeURI(e)):encodeURI(e)}function encodePercentString(e){return encodeURI(e).split("%25").map(decodeURI).join("%25")}function downloadData(e,t){var n=e.replace(/^.*[\\\/]/,"");log("filename",n);var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer",o.onload=function(e){var o=this.getResponseHeader("content-type")||"application/octet-stream",a=["pdf","jpg","jpeg","png","gif","bmp","ico","tiff","tif","jif","jiff","jp2","jpx","j2k","fpx","pcd"],i=!1;if(n){var s=n.split(".");if(s.length>1){var r=s[s.length-1].toLowerCase();for(var c in a)if(-1!=r.indexOf(a[c])){s[s.length-1]=a[c],i=!0;break}}(n=i?s.join("."):null)&&(-1!==n.indexOf("%")&&-1===n.indexOf("%25")&&(n=encodePercentString(encodePath(n)),log("file nmae in if: ",n)),n=decodeURIComponent(n))}var d=new Uint8Array(this.response);for(c=0;c<this.response.length;c++)d[c]=byteString.charCodeAt(c);createKey(new Blob([d],{type:o}),t,n)},o.send()}function createKey(e,t,n,o){if(e){if(o||(o=0),!n){var a=e.type.split("/")[1],i=[";",".","/",":","=","?","-"];for(var s in i){var r=a.indexOf(i[s]);if(r>-1){a=a.substring(0,r);break}}var c=new Date,d="(";d+=c.getFullYear()+"-",d+=addZero(c.getMonth()+1)+"-",d+=addZero(c.getDate())+" ",d+=addZero(c.getHours())+"-",d+=addZero(c.getMinutes())+"-",d+=addZero(c.getSeconds())+")",n="Send Anywhere "+d,"octet"!=a&&(n+="."+a)}var p={mode:"upload",file:[{name:n,size:e.size}]};$.ajax({url:hostname+"/web/key",type:"POST",data:p}).done((function(o,a,i){e.type.indexOf("image")>=0&&createThumbnail(o.thumbnail_url,e),uploadList[o.key]=t;var s=new FormData;s.append("sendanywhereExtension",e,n),sendFile(o.weblink,s,o.key);var r={key:o.key,link:o.link};sendCreateKeyMessage(t,r,(function(e){e||sendCreateKeyMessage(t,r)}))})).fail((function(e){log(e),chrome.tabs.sendMessage(t,{type:"fail_upload"})}))}}function sendCreateKeyMessage(e,t,n){e&&chrome.tabs.sendMessage(e,{type:"create_key",data:t},(function(e){n&&n(e)}))}function sendFile(e,t,n){var o=xhrList[n]=new XMLHttpRequest;o.upload.onprogress=function(e){chrome.tabs.sendMessage(uploadList[n],{type:"update_status",data:{total:e.total,done:e.loaded}})},o.onload=function(e){o.response&&"complete"==o.response.mode?(delete uploadList[n],delete xhrList[n]):onFail(n)},o.onerror=function(e){onFail(n)},o.open("POST",e,!0),o.responseType="json",o.send(t),ga("send","event","transfer","send","send_start")}function onFail(e){chrome.tabs.sendMessage(uploadList[e],{type:"fail_upload"}),deleteKey(e),delete uploadList[e],delete xhrList[e]}function cancelUpload(e){if(e){var t=xhrList[e].responseURL;t&&$.ajax({url:t,type:"GET",data:{mode:"cancel"}}).done((function(t){xhrList[e]&&xhrList[e].abort(),deleteKey(e)})).fail((function(e){}))}}function deleteKey(e){$.ajax({url:hostname+"/web/key/"+e,type:"DELETE",processData:!1}).done((function(e){})).fail((function(e){}))}function createThumbnail(e,t,n){var o=new FileReader,a=document.createElement("canvas"),i=a.getContext("2d");o.onload=function(t){var n=new Image;n.onload=function(){var t=n.width,o=n.height,s=0,r=0,c=300/t,d=300/o,p=c>d?c:d;(t*=p)>300&&(r=(t-300)/2*-1),(o*=p)>300&&(s=(o-300)/2*-1),a.width=300,a.height=300,i.fillStyle="#FFF",i.fillRect(0,0,300,300),i.drawImage(n,r,s,t,o);var l=dataURItoBlob(a.toDataURL("image/jpeg")),u=new File([l],"thumbnail.jpeg",{type:"image/jpeg"});sendThumbnail(e,u)},n.src=t.target.result},o.readAsDataURL(t)}function sendThumbnail(e,t){$.ajax({url:e,type:"PUT",data:t,contentType:"image/jpeg",processData:!1}).done((function(e){})).fail((function(e){log(e)}))}function dataURItoBlob(e){var t="";t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var n=e.split(",")[0].split(":")[1].split(";")[0],o=new Uint8Array(t.length),a=0;a<t.length;a++)o[a]=t.charCodeAt(a);return new Blob([o],{type:n})}function setCookie(e,t,n){var o=new Date;o.setTime(o.getTime()+31536e6),n||(n=hostname),e&&t&&chrome.cookies.set({url:n,expirationDate:o.getTime()/1e3,name:e,value:t,sameSite:"no_restriction",secure:!0})}function getMessage(e){return chrome.i18n.getMessage(e)}function addZero(e){return e<10?"0"+e:e}function addBrowserAction(){var e=!!getAppData("userId");log("addbrowseraction",e),e?chrome.browserAction.setPopup({popup:"/html/popup.html"}):(chrome.browserAction.setPopup({popup:""}),chrome.browserAction.onClicked.removeListener(openLoginPopup),chrome.browserAction.onClicked.addListener(openLoginPopup))}function openLoginPopup(){checkAuth((function(){var e={url:"/html/popup.html",type:"panel",focused:!0,width:400,height:400},t=BrowserDetect.OS;function n(){chrome.windows.create(e,(function(e){vid=e.id}))}"Windows"==t||"Chrome OS"==t?(e.width+=20,e.height+=50):"Mac"==t&&(e.height+=21),vid?chrome.windows.update(vid,{focused:!0},(function(){chrome.runtime.lastError&&n()})):n()}))}function closeLoginPopup(){vid&&chrome.windows.remove(vid)}function decodeJWT(e){var t=e.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(window.atob(t))}function getStorage(e,t){chrome.storage.sync.get(e,(function(n){null==e?t&&t(n):n[e]?t&&t(n[e]):t&&t(null)}))}function checkAuth(e){if(getAppData("updatedDevice")){var t=!1;chrome.cookies.getAll({url:hostname},(function(n){if(n.length>0)for(var o in n){var a=n[o];if("device_key"===a.name&&"string"==typeof a.value){t=!0;break}}t?e&&e():checkDeviceInfo((function(){e&&e()}))}))}else checkDeviceInfo((function(){e&&e()}))}function updateDevice(e,t){var n,o,a={os_type:"web",manufacturer:"CHROME"===ENV?"google":"Naver",model_number:"CHROME"===ENV?"ChromeExt":"WhaleExt",app_name:"CHROME"===ENV?"Send Anywhere Chrome Extension":"Send Anywhere Whale Extension",app_version:chrome.runtime.getManifest().version,device_language:chrome.i18n.getMessage("@@ui_locale")};e&&(a.profile_name=decodeURIComponent(e)),$.ajax({url:hostname+"/web/device",type:"POST",data:a}).done((function(e){setAppData("updatedDevice",!0),e.profile_name&&(setCookie("profile_name",e.profile_name),n=e.profile_name),chrome.cookies.getAll({url:hostname},(function(a){if(a.length>0){var i={};for(var s in a){var r=a[s];if("profile_name"===r.name)n=r.value;else if("device_key"===r.name)i.device_key=r.value;else if("session_key"===r.name){var c=decodeJWT(r.value);(o=getAppData("userId"))&&o!==c.id?o=void 0:c.id&&(o=c.id)}}n&&(i.profile_name=n),setAppData("userId",o),chrome.storage.sync.set({conf:i}),t&&t(null,e)}}))})).fail((function(n){401===n.status?setTimeout((function(){updateDevice(e)}),1e3):t&&t(n,null)}))}function checkDeviceInfo(e){getStorage(null,(function(t){var n;if(t){var o=t.conf;o&&(n=o.profile_name,o.device_key&&setCookie("device_key",o.device_key),n&&setCookie("profile_name",n)),setAppData("userId",t.user_id)}updateDevice(n,(function(t,n){e&&n&&e(n)}))}))}function check_device(){log("check_device"),chrome.cookies.get({url:hostname,name:"session_key"},(function(e){e||init()}))}function init(){"CHROME"===ENV&&addBrowserAction(),$.ajaxSetup({cache:!1}),chrome.contextMenus.removeAll(),checkDeviceInfo((function(){getStorage(null,(function(e){var t=e.options||{gmail:!0,images:!0,pdf:!0,slack:!0};chrome.storage.sync.set({options:t}),setAppData("options",t),t.images&&addContextMenu("image"),t.slack&&addContextMenu("editable"),e.hidden_slack_popup&&setAppData("showSlackPopup",!1)}))}))}chrome.storage.onChanged.addListener((function(e,t){if("sync"===t&&(log("onchange sync storage",e),e.user_id)){var n=e.user_id;getAppData("userId")!==n.newValue&&setAppData("userId",n.newValue)}})),chrome.runtime.onMessage.addListener((function(e,t,n){if(t.id==chrome.runtime.id){var o=getAppData("options"),a=!1;if("observe_pdf"==e.type)o.pdf&&(n({type:"load_pdf",hostname:hostname}),a=!0);else if("observe_gmail"==e.type)o.gmail&&(n({type:"load_gmail"}),a=!0);else if("observe_slack"==e.type)o.slack&&(n({type:"load_slack",show_slack_popup:getAppData("showSlackPopup")}),a=!0);else if("send_pdf"==e.type){!!getAppData("userId")?requestPdfPermissions((function(t){t&&(injectIframe(e.data),ga("send","event","context","click","pdf_share_bt"))})):alert(chrome.i18n.getMessage("login_required"))}else if("cancel"==e.type)cancelUpload(e.data);else if("open_webapp"==e.type)openWebapp();else if("change_profile"==e.type){if(!e.data)return;getStorage("conf",(function(t){if(t){var n={profile_name:e.data};t.device_key&&(n.device_key=t.device_key),chrome.storage.sync.set({conf:n},(function(){updateDevice(n.profile_name)}))}}))}else{if("check_auth"==e.type)return checkAuth((function(){n({type:"auth_check_done"}),a=!0})),!0;if("click_gmail"==e.type)ga("send","event","plugin","gmail","gmail_bt");else if("click_slack"==e.type)ga("send","event","plugin","slack","slack_bt");else if("changed_options"==e.type){if(!e.item)return;"images"==e.item&&(e.data?addContextMenu("image"):removeContextMenu("image")),"slack"==e.item&&(e.data?addContextMenu("editable"):removeContextMenu("editable")),o[e.item]=e.data,chrome.storage.sync.set({options:o})}else if("hidden_slack_popup"==e.type)setAppData("showSlackPopup",!1),chrome.storage.sync.set({hidden_slack_popup:!0});else if("attach_files"==e.type)e.service&&("editable"===e.service&&(e.service="input"),ga("send","event","plugin",e.service,e.service+"_attach"));else if("get_tab_id"==e.type)t.tab.id&&(n({tabId:t.tab.id}),a=!0);else if("updated_session_cookie"===e.type)updatedSessionCookie(e.data);else{if("check_device"!==e.type)return!1;check_device()}}return a||n(),!0}})),chrome.runtime.setUninstallURL(website_url+lang+"/file-transfer/"+ENV.toLowerCase()+"-extension-uninstall"),init();